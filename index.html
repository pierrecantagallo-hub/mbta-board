<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Central Square - Red Line MBTA Board</title>

<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  font-family: 'VT323', monospace;
  overflow-x: hidden;
}

.top-spacer {
  height: 60vh;
}

.board {
  transform: scale(0.6);
  transform-origin: top center;
}

header {
  background: #DA291C;
  padding: 20px;
  text-align: center;
  font-size: 4rem;
  font-weight: bold;
  position: relative;
  height: 15vh;
}

#clock {
  position: absolute;
  right: 20px;
  top: 20px;
  font-size: 2rem;
}

#alerts {
  background: #111;
  color: #FFD700;
  font-size: 2rem;
  padding: 10px 0;
  border-top: 2px solid #444;
  overflow: hidden;
  white-space: nowrap;
}

.scrolling {
  display: inline-block;
  padding-left: 100%;
  animation: scroll 25s linear infinite;
}

@keyframes scroll {
  0% { transform: translateX(0%); }
  100% { transform: translateX(-100%); }
}

.container {
  display: flex;
  justify-content: space-around;
  padding: 20px;
  min-height: 75vh;
}

.direction {
  width: 45%;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

.direction h2 {
  font-size: 3rem;
  border-bottom: 2px solid #444;
  padding-bottom: 10px;
  margin-bottom: 20px;
  text-align: center;
}

.train {
  font-size: 4.5rem;
  margin: 15px 0;
  display: flex;
  align-items: center;
}

.status {
  display: inline-block;
  width: 180px;
  font-weight: bold;
  margin-right: 20px;
  white-space: nowrap;
}

.destination {
  color: #FFD700;
  font-weight: bold;
}

.arriving, .boarding {
  animation: blink 1s infinite;
}

@keyframes blink {
  0%,50%,100% { opacity: 1; }
  25%,75% { opacity: 0; }
}
</style>
</head>
<body>

<div class="top-spacer"></div>

<div class="board">
  <header>
    Central Square â€” Red Line
    <div id="clock"></div>
  </header>

  <div id="alerts"><span class="scrolling" id="alert-text">Loading alerts...</span></div>

  <div class="container">
    <div class="direction">
      <h2>Toward Alewife</h2>
      <div id="northbound">Loading...</div>
    </div>

    <div class="direction">
      <h2>Toward Braintree / Ashmont</h2>
      <div id="southbound">Loading...</div>
    </div>
  </div>
</div>

<script>
const stopId = "place-cntsq";
const routeId = "Red";

let lastNorth = [];
let lastSouth = [];

// Boston time for clock
function updateClock() {
  const now = new Date();
  const options = { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit' };
  document.getElementById("clock").innerText = now.toLocaleTimeString([], options);
}

// Status logic: ARR if <=0 min, BRD if <=1 min (boarding)
function getStatus(departureTimeUtc) {
  const departure = new Date(departureTimeUtc);
  const now = new Date();
  const diff = (departure - now)/60000; // minutes
  if(diff <= 0) return 'ARR';
  if(diff <= 1) return 'BRD';
  return Math.round(diff) + ' MIN';
}

async function fetchPredictions() {
  try {
    const response = await fetch(
      `https://api-v3.mbta.com/predictions?filter[stop]=${stopId}&filter[route]=${routeId}&sort=departure_time&include=trip`
    );
    const data = await response.json();
    const northDiv = document.getElementById("northbound");
    const southDiv = document.getElementById("southbound");

    const north = [];
    const south = [];

    const tripHeadsigns = {};
    if(data.included){
      data.included.forEach(rel=>{
        if(rel.type==='trip'){
          tripHeadsigns[rel.id] = rel.attributes.headsign;
        }
      });
    }

    data.data.filter(p => p.attributes.departure_time).forEach(p => {
      const time = p.attributes.departure_time;
      const dest = tripHeadsigns[p.relationships.trip.data.id] || '';

      // Column based on headsign
      if(dest.includes("Alewife") && north.length<3) north.push({time,dest});
      else if((dest.includes("Braintree") || dest.includes("Ashmont")) && south.length<3) south.push({time,dest});
    });

    if(north.length === 0 && lastNorth.length) north.push(...lastNorth);
    if(south.length === 0 && lastSouth.length) south.push(...lastSouth);

    function render(div,list){
      div.innerHTML = "";
      if(list.length===0){div.innerHTML="<div class='train'>No trains</div>"; return;}
      list.forEach(train=>{
        const statusText = getStatus(train.time);
        let className = '';
        if(statusText==='ARR') className='arriving';
        if(statusText==='BRD') className='boarding';
        const el = document.createElement("div");
        el.className = "train";
        el.innerHTML = `<span class="status ${className}">${statusText}</span> <span class="destination">${train.dest}</span>`;
        div.appendChild(el);
      });
    }

    render(northDiv,north);
    render(southDiv,south);

    lastNorth = north;
    lastSouth = south;

  } catch(e){
    console.error("Error fetching predictions:", e);
    if(lastNorth.length) render(document.getElementById("northbound"), lastNorth);
    if(lastSouth.length) render(document.getElementById("southbound"), lastSouth);
  }
}

// Alerts with custom message when none
async function fetchAlerts() {
  try {
    const response = await fetch(`https://api-v3.mbta.com/alerts?filter[route]=${routeId}`);
    const data = await response.json();

    let alertText = data.data
      .map(a=>a.attributes.header_text || a.attributes.description_text)
      .filter(text=>text && text.trim()!=="")
      .join(' | ');

    if(!alertText || alertText.trim() === ""){
      alertText = "No current alerts | Welcome to Aidan and Pie's apartment";
    }

    document.getElementById("alert-text").innerText = alertText;
  } catch(e){
    console.error("Error fetching alerts:", e);
    document.getElementById("alert-text").innerText = "No current alerts | Welcome to Aidan and Pie's apartment";
  }
}

updateClock();
fetchPredictions();
fetchAlerts();

setInterval(updateClock,1000);
setInterval(fetchPredictions,10000);
setInterval(fetchAlerts,15000);
</script>

</body>
</html>
