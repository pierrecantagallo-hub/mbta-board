<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Central Square - Red Line MBTA Board</title>
<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: 'Courier New', monospace;
  overflow-x: hidden;
}

header {
  background: #DA291C;
  padding: 20px;
  text-align: center;
  font-size: 2.5rem;
  font-weight: bold;
  position: relative;
}

#clock {
  position: absolute;
  right: 20px;
  top: 20px;
  font-size: 1.5rem;
}

#alerts {
  background: #111;
  color: #FFD700;
  font-size: 1.2rem;
  padding: 10px 0;
  border-top: 2px solid #444;
  overflow: hidden;
  white-space: nowrap;
}

.scrolling {
  display: inline-block;
  padding-left: 100%;
  animation: scroll 20s linear infinite;
}

@keyframes scroll {
  0% { transform: translateX(0%); }
  100% { transform: translateX(-100%); }
}

.container {
  display: flex;
  justify-content: space-around;
  padding: 30px;
}

.direction {
  width: 45%;
}

.direction h2 {
  font-size: 2rem;
  border-bottom: 2px solid #444;
  padding-bottom: 10px;
  margin-bottom: 20px;
  text-align: center;
}

.train {
  font-size: 2rem;
  margin: 10px 0;
  text-align: left;
}

.status {
  display: inline-block;
  width: 60px;
  font-weight: bold;
}

.destination {
  color: #FFD700;
  font-weight: bold;
}
</style>
</head>
<body>

<header>
  Central Square — Red Line
  <div id="clock"></div>
</header>

<div id="alerts"><span class="scrolling" id="alert-text">Loading alerts...</span></div>

<div class="container">
  <div class="direction">
    <h2>Toward Alewife</h2>
    <div id="northbound">Loading...</div>
  </div>

  <div class="direction">
    <h2>Toward Braintree / Ashmont</h2>
    <div id="southbound">Loading...</div>
  </div>
</div>

<script>
const stopId = "place-cntsq";
const routeId = "Red";

function updateClock() {
  const now = new Date();
  document.getElementById("clock").innerText =
    now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Generate train status text: ARR, BRD, or MIN
function getStatus(departureTime) {
  const now = new Date();
  const diff = (departureTime - now)/60000;
  if (diff <= 0) return 'ARR';
  if (diff <= 1) return 'BRD';
  return Math.round(diff) + ' MIN';
}

async function fetchPredictions() {
  try {
    const response = await fetch(
      `https://api-v3.mbta.com/predictions?filter[stop]=${stopId}&filter[route]=${routeId}&sort=departure_time`
    );
    const data = await response.json();
    const now = new Date();

    const northDiv = document.getElementById("northbound");
    const southDiv = document.getElementById("southbound");
    northDiv.innerHTML = "";
    southDiv.innerHTML = "";

    const north = [];
    const south = [];

    data.data
      .filter(p => p.attributes.departure_time)
      .forEach(p => {
        const time = new Date(p.attributes.departure_time);
        if (p.attributes.direction_id === 0 && north.length < 3) north.push({time, dest: "Alewife"});
        if (p.attributes.direction_id === 1 && south.length < 3) south.push({time, dest: "Braintree / Ashmont"});
      });

    function render(div, list) {
      if (list.length === 0) {
        div.innerHTML = "<div class='train'>No trains</div>";
        return;
      }
      list.forEach(train => {
        const statusText = getStatus(train.time);
        const el = document.createElement("div");
        el.className = "train";
        el.innerHTML = `<span class="status">${statusText}</span> <span class="destination">Red → ${train.dest}</span>`;
        div.appendChild(el);
      });
    }

    render(northDiv, north);
    render(southDiv, south);

  } catch(e) {
    console.error("Error fetching predictions:", e);
  }
}

async function fetchAlerts() {
  try {
    const response = await fetch(`https://api-v3.mbta.com/alerts?filter[route]=${routeId}`);
    const data = await response.json();
    const alertText = data.data
      .map(a => a.attributes.header_text || a.attributes.description_text)
      .filter(text => text && text.trim() !== "")
      .join(' | ');

    document.getElementById("alert-text").innerText = alertText || "No current alerts";
  } catch(e) {
    console.error("Error fetching alerts:", e);
    document.getElementById("alert-text").innerText = "No current alerts";
  }
}

updateClock();
fetchPredictions();
fetchAlerts();

// Intervals
setInterval(updateClock, 1000);          // clock every second
setInterval(fetchPredictions, 10000);    // fetch departures every 10 sec
setInterval(fetchAlerts, 15000);         // fetch alerts every 15 sec
</script>

</body>
</html>
