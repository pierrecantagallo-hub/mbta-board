<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MBTA Countdown Clock</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #1a1a1a;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Share Tech Mono', monospace;
    }

    /* LED dot-matrix font via SVG pixel segments */
    @font-face {
      font-family: 'DSEG7';
      /* fallback to monospace for digits */
    }

    @keyframes ledFlicker {
      0%, 100% { opacity: 1; }
      92% { opacity: 1; }
      93% { opacity: 0.85; }
      94% { opacity: 1; }
    }

    @keyframes scrollText {
      0%   { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    @-webkit-keyframes scrollText {
      0%   { -webkit-transform: translateX(0); }
      100% { -webkit-transform: translateX(-50%); }
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.15; }
    }

    @keyframes arrBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .clock-wrap {
      width: 100%;
      max-width: 720px;
      padding: 20px;
    }

    /* Outer housing */
    .housing {
      background: #0f0f0f;
      border: 3px solid #2a2a2a;
      border-radius: 6px;
      overflow: hidden;
      box-shadow:
        0 0 0 1px #111,
        0 8px 32px rgba(0,0,0,0.9),
        inset 0 1px 0 rgba(255,255,255,0.04);
      animation: ledFlicker 8s ease-in-out infinite;
    }

    /* Red header bar */
    .header-bar {
      background: #CC0000;
      padding: 7px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid #990000;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mbta-bug {
      width: 22px;
      height: 22px;
      background: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 900;
      color: #CC0000;
      letter-spacing: -0.5px;
      font-family: Arial, sans-serif;
    }

    .header-title {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.75rem;
      color: #fff;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .header-clock {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.8);
      letter-spacing: 2px;
    }

    /* LED Screen area */
    .led-screen {
      background: #080808;
      padding: 0;
    }

    /* Station name row */
    .station-row {
      background: #0d0d0d;
      border-bottom: 1px solid #1a1a1a;
      padding: 6px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .station-label {
      font-size: 0.55rem;
      color: #444;
      letter-spacing: 3px;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .station-name-led {
      font-size: 0.85rem;
      color: #ff8c00;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-shadow: 0 0 8px rgba(255,140,0,0.6);
    }

    /* Direction header */
    .direction-header {
      background: #111;
      border-bottom: 1px solid #1c1c1c;
      padding: 5px 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    .dir-label {
      font-size: 0.55rem;
      color: #555;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .dir-label:last-child {
      border-left: 1px solid #1c1c1c;
      padding-left: 16px;
    }

    /* Train rows */
    .trains-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      border-bottom: 1px solid #161616;
    }

    .trains-col {
      padding: 10px 16px 14px;
    }

    .trains-col:first-child {
      border-right: 1px solid #1c1c1c;
    }

    /* Individual train entry */
    .train-entry {
      display: flex;
      align-items: center;
      gap: 0;
      margin-bottom: 8px;
      height: 36px;
    }

    .train-entry:last-child {
      margin-bottom: 0;
    }

    /* LED minutes number */
    .led-num {
      font-family: 'Share Tech Mono', monospace;
      font-size: 1.9rem;
      line-height: 1;
      min-width: 52px;
      text-align: right;
      color: #ff8c00;
      text-shadow:
        0 0 4px rgba(255,140,0,0.9),
        0 0 12px rgba(255,100,0,0.5),
        0 0 24px rgba(255,80,0,0.2);
      letter-spacing: -1px;
      /* Simulate dot matrix by layering */
      position: relative;
    }

    .led-num.arr {
      font-size: 1.9rem;
      color: #ffcc00;
      text-shadow:
        0 0 4px rgba(255,200,0,0.9),
        0 0 12px rgba(255,180,0,0.5);
      animation: arrBlink 0.8s ease-in-out infinite;
      letter-spacing: -1px;
      min-width: 52px;
    }

    .led-min-label {
      font-size: 0.5rem;
      color: #884400;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding-left: 3px;
      padding-bottom: 2px;
      align-self: flex-end;
      width: 20px;
    }

    .led-dest {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.75rem;
      color: #ff8c00;
      letter-spacing: 1px;
      text-transform: uppercase;
      text-shadow: 0 0 6px rgba(255,140,0,0.4);
      padding-left: 6px;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .led-dest.braintree {
      color: #00aaff;
      text-shadow: 0 0 6px rgba(0,150,255,0.4);
    }

    /* Dot matrix texture overlay on numbers */
    .led-num::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(circle, transparent 30%, rgba(0,0,0,0.25) 31%);
      background-size: 3px 3px;
      pointer-events: none;
    }

    /* Separator line */
    .separator {
      height: 1px;
      background: linear-gradient(90deg, transparent, #222, #222, transparent);
      margin: 0 16px;
    }

    /* Ticker */
    .ticker-bar {
      background: #080808;
      border-top: 1px solid #161616;
      height: 24px;
      overflow: hidden;
      position: relative;
    }

    .ticker-bar::before,
    .ticker-bar::after {
      content: '';
      position: absolute;
      top: 0; bottom: 0;
      width: 30px;
      z-index: 2;
    }
    .ticker-bar::before { left: 0; background: linear-gradient(90deg, #080808, transparent); }
    .ticker-bar::after  { right: 0; background: linear-gradient(-90deg, #080808, transparent); }

    .ticker-text {
      display: inline-block;
      white-space: nowrap;
      font-size: 0.6rem;
      color: #ff8c00;
      text-shadow: 0 0 6px rgba(255,140,0,0.4);
      letter-spacing: 2px;
      text-transform: uppercase;
      line-height: 24px;
      animation: scrollText 40s linear infinite;
      -webkit-animation: scrollText 40s linear infinite;
    }

    /* Status footer */
    .status-bar {
      background: #0a0a0a;
      border-top: 1px solid #161616;
      padding: 5px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-text {
      font-size: 0.5rem;
      color: #333;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .status-led {
      width: 5px;
      height: 5px;
      border-radius: 50%;
    }

    .status-led.ok {
      background: #00ff44;
      box-shadow: 0 0 4px #00ff44;
      animation: blink 2s ease-in-out infinite;
    }

    .status-led.error {
      background: #ff2200;
      box-shadow: 0 0 4px #ff2200;
    }

    .status-led.loading {
      background: #ffaa00;
      box-shadow: 0 0 4px #ffaa00;
      animation: blink 0.5s ease-in-out infinite;
    }

    /* Empty/loading states */
    .led-placeholder {
      font-size: 0.6rem;
      color: #333;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 4px 0;
      animation: blink 1s ease-in-out infinite;
    }

    .led-error {
      font-size: 0.55rem;
      color: #661100;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 4px 0;
    }

    /* Controls */
    .controls-bar {
      background: #0c0c0c;
      border-top: 2px solid #CC0000;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ctrl-label {
      font-size: 0.5rem;
      color: #444;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .led-select {
      background: #080808;
      border: 1px solid #2a2a2a;
      color: #ff8c00;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: 2px;
      cursor: pointer;
      outline: none;
      letter-spacing: 1px;
      text-transform: uppercase;
      appearance: none;
    }

    .led-select option {
      background: #080808;
      color: #ff8c00;
    }

    .led-btn {
      margin-left: auto;
      background: transparent;
      border: 1px solid #2a2a2a;
      color: #444;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.55rem;
      padding: 3px 10px;
      border-radius: 2px;
      cursor: pointer;
      letter-spacing: 2px;
      text-transform: uppercase;
      transition: all 0.15s;
    }

    .led-btn:hover {
      border-color: #ff8c00;
      color: #ff8c00;
      box-shadow: 0 0 6px rgba(255,140,0,0.2);
    }

    /* Phosphor glow on whole screen */
    .led-screen-inner {
      position: relative;
    }
    .led-screen-inner::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at 50% 40%, rgba(255,100,0,0.03) 0%, transparent 70%);
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const STATIONS = [
      { id: "place-alfcl", name: "Alewife" },
      { id: "place-davis", name: "Davis" },
      { id: "place-portr", name: "Porter Sq" },
      { id: "place-harsq", name: "Harvard Sq" },
      { id: "place-cntsq", name: "Central Sq" },
      { id: "place-knncl", name: "Kendall/MIT" },
      { id: "place-pktrm", name: "Park St" },
      { id: "place-dwnxg", name: "Downtow Xing" },
      { id: "place-sstat", name: "South Sta" },
      { id: "place-brdwy", name: "Broadway" },
      { id: "place-andrw", name: "Andrew" },
      { id: "place-jfk",   name: "JFK/UMass" },
      { id: "place-shmnl", name: "Shawmut" },
      { id: "place-asmnl", name: "Ashmont" },
      { id: "place-nqncy", name: "Quincy Ctr" },
      { id: "place-brntn", name: "Braintree" },
    ];

    function minsUntil(isoTime) {
      if (!isoTime) return null;
      const diff = (new Date(isoTime) - new Date()) / 1000 / 60;
      return Math.max(0, Math.round(diff));
    }

    function LedNum({ mins }) {
      if (mins <= 1) {
        return <div className="led-num arr">BRD</div>;
      }
      return <div className="led-num">{String(mins).padStart(2, ' ')}</div>;
    }

    function TrainRow({ mins, dest }) {
      const isBraintree = dest.toLowerCase().includes("braintree");
      const arriving = mins <= 1;
      return (
        <div className="train-entry">
          <LedNum mins={mins} />
          {!arriving && <div className="led-min-label">min</div>}
          <div className={`led-dest${isBraintree ? ' braintree' : ''}`}>{dest}</div>
        </div>
      );
    }

    function TrainRows({ trains }) {
      const rows = [...trains];
      while (rows.length < 3) rows.push(null);
      return rows.map((t, i) => t
        ? <TrainRow key={i} mins={t.mins} dest={t.dest} />
        : <div key={i} className="train-entry">
            <div className="led-num" style={{color:'#2a1800'}}>--</div>
            <div className="led-min-label" style={{color:'#1a0e00'}}>min</div>
            <div className="led-dest" style={{color:'#2a1800'}}>-------</div>
          </div>
      );
    }

    function App() {
      const [stationId, setStationId] = useState("place-cntsq");
      const [alewife, setAlewife]     = useState([]);
      const [south, setSouth]         = useState([]);
      const [status, setStatus]       = useState("loading");
      const [updatedAt, setUpdatedAt] = useState(null);
      const [clock, setClock]         = useState("");
      const [ticker, setTicker]       = useState("Fetching live data from MBTA...");

      const stationObj = STATIONS.find(s => s.id === stationId);
      const stationName = stationObj?.name || stationId;

      useEffect(() => {
        const tick = () => setClock(new Date().toLocaleTimeString("en-US", {
          hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
        }));
        tick();
        const id = setInterval(tick, 1000);
        return () => clearInterval(id);
      }, []);

      const fetchPredictions = useCallback(async () => {
        setStatus("loading");
        try {
          const [predRes, alertRes] = await Promise.all([
            fetch(`https://api-v3.mbta.com/predictions?filter[stop]=${stationId}&filter[route]=Red&sort=arrival_time&include=trip`),
            fetch(`https://api-v3.mbta.com/alerts?filter[route]=Red&filter[activity]=BOARD,EXIT,RIDE`)
          ]);

          if (!predRes.ok) throw new Error("fail");
          const data = await predRes.json();

          const tripDests = {};
          (data.included || []).forEach(inc => {
            if (inc.type === "trip") tripDests[inc.id] = inc.attributes.headsign || "";
          });

          const al = [], so = [];
          data.data.forEach(pred => {
            const dir = pred.attributes.direction_id;
            const t = pred.attributes.arrival_time || pred.attributes.departure_time;
            if (!t) return;
            const mins = minsUntil(t);
            if (mins === null || mins > 60) return;
            const tripId = pred.relationships?.trip?.data?.id;
            const dest = tripDests[tripId] || (dir === 1 ? "Alewife" : "Braintree");
            (dir === 1 ? al : so).push({ mins, dest });
          });

          al.sort((a, b) => a.mins - b.mins);
          so.sort((a, b) => a.mins - b.mins);
          setAlewife(al.slice(0, 3));
          setSouth(so.slice(0, 3));

          const now = new Date().toLocaleTimeString("en-US", {
            hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
          });
          setUpdatedAt(now);
          setStatus("ok");

          // Build ticker: welcome message + live alerts
          const welcome = "Welcome to Aidan and Pierre's Apartment  //  ";
          let alertParts = [];
          if (alertRes.ok) {
            const alertData = await alertRes.json();
            alertParts = alertData.data
              .filter(a => ["DELAY","SUSPENSION","SHUTTLE","STOP_CLOSURE","DETOUR","SERVICE_CHANGE","TRACK_CHANGE"].includes(a.attributes.effect))
              .slice(0, 5)
              .map(a => (a.attributes.header || a.attributes.short_header || "").replace(/\s+/g, ' ').trim())
              .filter(Boolean);
          }

          const tickerContent = alertParts.length > 0
            ? `${welcome}⚠ SERVICE ALERT  //  ${alertParts.join("  //  ⚠  ")}  //  `
            : `${welcome}No active service alerts on the Red Line  //  Good service on all branches  //  `;

          setTicker(tickerContent);
        } catch(e) {
          setStatus("error");
          setTicker("Welcome to Aidan and Pierre's Apartment  //  MBTA API UNAVAILABLE  //  CHECK YOUR CONNECTION  //  ");
        }
      }, [stationId]);

      useEffect(() => {
        fetchPredictions();
        const id = setInterval(fetchPredictions, 30000);
        return () => clearInterval(id);
      }, [fetchPredictions]);

      return (
        <div className="clock-wrap">
          <div className="housing">

            {/* Red header */}
            <div className="header-bar">
              <div className="header-logo">
                <div className="mbta-bug">T</div>
                <div className="header-title">Massachusetts Bay Transportation Authority</div>
              </div>
              <div className="header-clock">{clock}</div>
            </div>

            <div className="led-screen-inner">
              {/* Station name */}
              <div className="station-row">
                <div className="station-label">Station</div>
                <div className="station-name-led">{stationName.toUpperCase()}</div>
                <div className="station-label" style={{marginLeft:'auto', color:'#ff8c00', opacity:0.5}}>● Red Line</div>
              </div>

              {/* Direction headers */}
              <div className="direction-header">
                <div className="dir-label">▲ Toward Alewife</div>
                <div className="dir-label">▼ Toward Braintree / Ashmont</div>
              </div>

              {/* Train data */}
              <div className="trains-grid">
                {/* Alewife column */}
                <div className="trains-col">
                  {status === "loading" && <>
                    {[0,1,2].map(i => <div key={i} className="train-entry"><div className="led-num" style={{color:'#2a1800', animation:'blink 1s infinite'}}>--</div><div className="led-min-label" style={{color:'#1a0e00'}}>min</div><div className="led-dest" style={{color:'#2a1800'}}>-------</div></div>)}
                  </>}
                  {status !== "loading" && <TrainRows trains={alewife} />}
                </div>

                {/* South column */}
                <div className="trains-col">
                  {status === "loading" && <>
                    {[0,1,2].map(i => <div key={i} className="train-entry"><div className="led-num" style={{color:'#2a1800', animation:'blink 1s infinite'}}>--</div><div className="led-min-label" style={{color:'#1a0e00'}}>min</div><div className="led-dest" style={{color:'#2a1800'}}>-------</div></div>)}
                  </>}
                  {status !== "loading" && <TrainRows trains={south} />}
                </div>
              </div>

              {/* Ticker */}
              <div className="ticker-bar">
                <div className="ticker-text" style={{WebkitAnimation:"scrollText 40s linear infinite"}}>{ticker}{ticker}{ticker}</div>
              </div>
            </div>

            {/* Controls */}
            <div className="controls-bar">
              <div className="ctrl-label">Station</div>
              <select
                className="led-select"
                value={stationId}
                onChange={e => setStationId(e.target.value)}
              >
                {STATIONS.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
              </select>
              <button className="led-btn" onClick={fetchPredictions}>↺ Refresh</button>
            </div>

            {/* Status bar */}
            <div className="status-bar">
              <div className="status-text">
                {updatedAt ? `Last update: ${updatedAt}` : 'Connecting to MBTA...'}
              </div>
              <div className="status-text" style={{color:'#2a2a2a'}}>MBTA API v3</div>
              <div className={`status-led ${status}`}></div>
            </div>

          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
