<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Central Square - Red Line MBTA Board</title>

<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  font-family: 'VT323', monospace;
  overflow-x: hidden;
}

/* Tall page trick to force scroll + hide Switch UI */
.top-spacer {
  height: 60vh; /* big spacer pushes the board down */
}

/* Scaled-down board */
.board {
  transform: scale(0.6); /* shrink to 60% */
  transform-origin: top center;
}

header {
  background: #DA291C;
  padding: 20px;
  text-align: center;
  font-size: 4rem;
  font-weight: bold;
  position: relative;
  height: 15vh;
}

#clock {
  position: absolute;
  right: 20px;
  top: 20px;
  font-size: 2rem;
}

#alerts {
  background: #111;
  color: #FFD700;
  font-size: 2rem;
  padding: 10px 0;
  border-top: 2px solid #444;
  overflow: hidden;
  white-space: nowrap;
}

.scrolling {
  display: inline-block;
  padding-left: 100%;
  animation: scroll 25s linear infinite;
}

@keyframes scroll {
  0% { transform: translateX(0%); }
  100% { transform: translateX(-100%); }
}

.container {
  display: flex;
  justify-content: space-around;
  padding: 20px;
  min-height: 75vh;
}

.direction {
  width: 45%;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

.direction h2 {
  font-size: 3rem;
  border-bottom: 2px solid #444;
  padding-bottom: 10px;
  margin-bottom: 20px;
  text-align: center;
}

.train {
  font-size: 4.5rem;
  margin: 15px 0;
  display: flex;
  align-items: center;
}

.status {
  display: inline-block;
  width: 180px;
  font-weight: bold;
  margin-right: 20px;
  white-space: nowrap;
}

.destination {
  color: #FFD700;
  font-weight: bold;
}

.arriving, .boarding {
  animation: blink 1s infinite;
}

@keyframes blink {
  0%,50%,100% { opacity: 1; }
  25%,75% { opacity: 0; }
}
</style>
</head>
<body>

<div class="top-spacer"></div>

<div class="board">
  <header>
    Central Square â€” Red Line
    <div id="clock"></div>
  </header>

  <div id="alerts"><span class="scrolling" id="alert-text">Loading alerts...</span></div>

  <div class="container">
    <div class="direction">
      <h2>Toward Alewife</h2>
      <div id="northbound">Loading...</div>
    </div>

    <div class="direction">
      <h2>Toward Braintree / Ashmont</h2>
      <div id="southbound">Loading...</div>
    </div>
  </div>
</div>

<script>
const stopId = "place-cntsq";
const routeId = "Red";

function updateClock() {
  const now = new Date();
  document.getElementById("clock").innerText =
    now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function getStatus(departureTime) {
  const now = new Date();
  const diff = (departureTime - now)/60000;
  if(diff <= 0) return 'ARR';
  if(diff <= 1) return 'BRD';
  return Math.round(diff) + ' MIN';
}

async function fetchPredictions() {
  try {
    const response = await fetch(
      `https://api-v3.mbta.com/predictions?filter[stop]=${stopId}&filter[route]=${routeId}&sort=departure_time&include=trip`
    );
    const data = await response.json();
    const northDiv = document.getElementById("northbound");
    const southDiv = document.getElementById("southbound");
    northDiv.innerHTML = "";
    southDiv.innerHTML = "";

    const north = [];
    const south = [];

    const tripHeadsigns = {};
    if(data.included){
      data.included.forEach(rel=>{
        if(rel.type==='trip'){
          tripHeadsigns[rel.id] = rel.attributes.headsign;
        }
      });
    }

    data.data.filter(p => p.attributes.departure_time).forEach(p => {
      const time = new Date(p.attributes.departure_time);
      const dest = tripHeadsigns[p.relationships.trip.data.id] || '';
      if(p.attributes.direction_id===0 && north.length<3) north.push({time,dest});
      if(p.attributes.direction_id===1 && south.length<3) south.push({time,dest});
    });

    function render(div,list){
      if(list.length===0){div.innerHTML="<div class='train'>No trains</div>"; return;}
      list.forEach(train=>{
        const statusText = getStatus(train.time);
        let className = '';
        if(statusText==='ARR') className='arriving';
        if(statusText==='BRD') className='boarding';
        const el = document.createElement("div");
        el.className = "train";
        el.innerHTML = `<span class="status ${className}">${statusText}</span> <span class="destination">${train.dest}</span>`;
        div.appendChild(el);
      });
    }

    render(northDiv,north);
    render(southDiv,south);

  } catch(e){console.error("Error fetching predictions:",e);}
}

async function fetchAlerts() {
  try {
    const response = await fetch(`https://api-v3.mbta.com/alerts?filter[route]=${routeId}`);
    const data = await response.json();
    const alertText = data.data.map(a=>a.attributes.header_text||a.attributes.description_text)
      .filter(text=>text && text.trim()!=="").join(' | ');
    document.getElementById("alert-text").innerText = alertText || "No current alerts";
  } catch(e){console.error("Error fetching alerts:",e); document.getElementById("alert-text").innerText="No current alerts";}
}

updateClock();
fetchPredictions();
fetchAlerts();

setInterval(updateClock,1000);
setInterval(fetchPredictions,10000);
setInterval(fetchAlerts,15000);
</script>

</body>
</html>
